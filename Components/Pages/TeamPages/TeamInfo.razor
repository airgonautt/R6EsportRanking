@page "/teams/{teamName}"

@using R6Ranking.Models
@using Microsoft.EntityFrameworkCore
@using R6Ranking.Data

@using R6Ranking.Components.Splashable
@inject IDbContextFactory<R6Ranking.Data.R6EsportsDbContext> DbFactory
@inject NavigationManager NavManager

<div class="main-layout container" style="background-color: #343A40; border:8px solid; border-radius:5px; border-color: @(string.IsNullOrWhiteSpace(team?.PrimaryColor) ? "#fbac40" : team.PrimaryColor);">
    <!-- Header and Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4" style="background-color:@(string.IsNullOrWhiteSpace(team?.PrimaryColor) ? "#fbac40" : team.PrimaryColor);
            border-bottom-left-radius:15px; border-bottom-right-radius:15px;">

        <!-- Back Button -->
        <button class="custom-btn" @onclick="NavigateToLowerEloTeam" title="Back">
            <i class="bi bi-caret-left fa-6x"></i>
        </button>

        <div class="d-flex align-items-center">
            <img src="@team?.LogoUrl" alt="Team Logo" class="img-fluid me-3 team-logo" style="filter: drop-shadow(3px 3px 2px var(--bs-black--3))">
            <div>
                <h2 class="fw-bold text-white mb-1" style="filter: drop-shadow(3px 3px 1px var(--bs-black--3))">@team?.TeamName</h2>
                <h4 class="text-warning mb-0" style="filter: drop-shadow(3px 3px 1px var(--bs-black--3))">@team?.CurrentElo RP</h4>
            </div>
        </div>

        <!-- Next Button -->
        <button class="custom-btn" @onclick="NavigateToHigherEloTeam" title="Next">
            <i class="bi bi-caret-right fa-6x"></i>
        </button>
    </div>

    <!-- Elo History Section -->
    <div>
        @if (team != null)
        {
            <TeamGraph Team="@team" PrimaryColor="@(string.IsNullOrWhiteSpace(team?.PrimaryColor) ? "#fbac40" : team.PrimaryColor)" />
        }
    </div>

    <!-- Player Roster Section -->
    <div class="cards-container">
        @if (Players != null)
        {
            @foreach (var player in Players)
            {
                <div class="pack-grid-item">
                    <PlayerCard Player="@player" />
                </div>
            }
        }
        else
        {
            <p>Loading players...</p>
        }
    </div>

    <!-- Elo History Grid -->
    <div>
        @if (team != null)
        {
            <TeamGrid Team="@team" PrimaryColor="@(string.IsNullOrWhiteSpace(team?.PrimaryColor) ? "#fbac40" : team.PrimaryColor)" />
        }
    </div>
</div>

@code {

    [Parameter] public string teamName { get; set; } = default!;
    private Team? team;
    private List<TeamEloChange> EloHistory = new();
    private List<Player>? Players = new();

    private bool IsRosterLoaded = false;
    private bool IsHistoryLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        var context = await DbFactory.CreateDbContextAsync();
        team = await context.Teams
        .Include(t => t.Players)
        .FirstOrDefaultAsync(team=>team.TeamName == teamName);


        if (team != null)
        {
            EloHistory = await context.TeamEloChanges
                .Where(e => e.TeamID == team.TeamID)
                .OrderBy(e => e.Date)
                .ToListAsync(); 

            Players = team.Players.ToList();
        }        
    }

    private async Task NavigateToLowerEloTeam()
    {
        var context = await DbFactory.CreateDbContextAsync();
        var lowerTeam = await context.Teams
            .Where(t => t.CurrentElo < team!.CurrentElo)
            .OrderByDescending(t => t.CurrentElo)
            .FirstOrDefaultAsync();

        NavManager.NavigateTo($"/teams/{lowerTeam?.TeamName}", forceLoad: true);
    }
    private async Task NavigateToHigherEloTeam()
    {
        var context = await DbFactory.CreateDbContextAsync();
        var higherTeam = await context.Teams
            .Where(t => t.CurrentElo > team!.CurrentElo)
            .OrderBy(t => t.CurrentElo)
            .FirstOrDefaultAsync();

        NavManager.NavigateTo($"/teams/{higherTeam?.TeamName}", forceLoad: true);
    }
}

<style>
    .custom-btn {
        background-color: var(--bs-black--1);
        border: 2px solid var(--bs-gold---1);
        color: var(--bs-gold---1);
        padding: 10px 15px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease-in-out;
    }

        .custom-btn:hover {
            background-color: var(--bs-gold---1);
            color: var(--bs-black--1);
            border-color: var(--bs-black--1);
        }

    .custom-arrow {
        margin: 0 5px;
        font-size: 18px;
        font-weight: bold;
    }
</style>